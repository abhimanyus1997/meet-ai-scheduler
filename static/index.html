<!DOCTYPE html>
<html lang="en">

<head>
    <title>Smart Calendar</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        #events {
            margin-top: 2rem;
        }

        .event {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #eventForm {
            margin-top: 2rem;
        }

        #userInfo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }

        #userInfo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <h1>Smart Scheduler: Google Calendar</h1>
    <div id="userInfo"></div>
    <button id="loginBtn" onclick="authenticate()">Login with Google</button>
    <button onclick="logout()">Logout</button>

    <div id="events"></div>

    <h2>Add Event</h2>
    <form id="eventForm">
        <label>Title: <input type="text" name="summary" required /></label><br />
        <label>Start Time: <input type="datetime-local" name="start" required /></label><br />
        <label>End Time: <input type="datetime-local" name="end" required /></label><br />
        <button type="submit">Create Event</button>
    </form>

    <script>
        let accessToken = null;
        let userName = null;
        let userPicture = null;

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("user_name");
            localStorage.removeItem("user_picture");
            location.href = "/";
        }

        async function authenticate() {
            const res = await fetch("/login/google");
            const data = await res.json();
            window.location.href = data.auth_url;
        }

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function fetchToken() {
                const token = getQueryParam("token");
                const name = getQueryParam("name");
                const picture = getQueryParam("picture");

                if (!token) return;

                accessToken = token;
                localStorage.setItem("access_token", accessToken);

                if (name && picture) {
                    userName = decodeURIComponent(name);
                    userPicture = decodeURIComponent(picture);
                    localStorage.setItem("user_name", userName);
                    localStorage.setItem("user_picture", userPicture);
                }

                window.history.replaceState({}, document.title, "/");

                displayUserInfo();
                await loadEvents();
            }


            function displayUserInfo() {
                    userName = localStorage.getItem("user_name");
                    userPicture = localStorage.getItem("user_picture");

                    const userDiv = document.getElementById("userInfo");
                    if (userName && userPicture) {
                        const safePicture = encodeURI(userPicture);
                        userDiv.innerHTML = `
            <img src="${safePicture}" alt="User Picture" />
            <span>Welcome, ${userName}</span>
        `;
                    } else {
                        userDiv.innerHTML = "";
                    }
                }


        async function loadEvents() {
            if (!accessToken) accessToken = localStorage.getItem("access_token");

            try {
                const res = await fetch("/events", {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });

                if (!res.ok) throw new Error("Unauthorized or failed to fetch events");

                const data = await res.json();
                const eventsContainer = document.getElementById("events");
                eventsContainer.innerHTML = "<h2>Upcoming Events</h2>";

                data.forEach(event => {
                    const div = document.createElement("div");
                    div.className = "event";
                    div.innerHTML = `
                        <strong>${event.summary || 'No Title'}</strong><br/>
                        ${event.start?.dateTime || event.start?.date} â†’ ${event.end?.dateTime || event.end?.date}
                        <br/>
                        <button onclick="deleteEvent('${event.id}')">Delete</button>
                        <button onclick="editEvent('${event.id}', '${event.summary}', '${event.start?.dateTime || ''}', '${event.end?.dateTime || ''}')">Edit</button>
                    `;
                    eventsContainer.appendChild(div);
                });

            } catch (err) {
                alert("Failed to load events. Please login again.");
                logout();
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm("Are you sure you want to delete this event?")) return;

            await fetch(`/events/${eventId}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            await loadEvents();
        }

        function editEvent(id, summary, start, end) {
            const form = document.getElementById("eventForm");
            form.dataset.editing = id;
            form.summary.value = summary;
            form.start.value = new Date(start).toISOString().slice(0, 16); // datetime-local format
            form.end.value = new Date(end).toISOString().slice(0, 16);
        }

        document.getElementById("eventForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const body = {
                summary: formData.get("summary"),
                start: { dateTime: new Date(formData.get("start")).toISOString() },
                end: { dateTime: new Date(formData.get("end")).toISOString() }
            };

            const isEditing = form.dataset.editing;

            if (isEditing) {
                await fetch(`/events/${isEditing}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(body)
                });
                delete form.dataset.editing;
            } else {
                await fetch("/events", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(body)
                });
            }

            form.reset();
            await loadEvents();
        });

        window.onload = () => {
            accessToken = localStorage.getItem("access_token");
            displayUserInfo();
            if (accessToken) {
                document.getElementById("loginBtn").style.display = "none";
                loadEvents();
            } else {
                fetchToken();
            }
        };
    </script>
</body>

</html>